ARG SOURCE_IMAGE_NAME
ARG BUILD_IMAGE_NAME

FROM "$SOURCE_IMAGE_NAME" as source
  USER root
  RUN mkdir -p /project
  ARG UID
  RUN chown "$UID:$UID" /project
  USER $UID

FROM "$BUILD_IMAGE_NAME" as build
  USER root
  RUN mkdir -p /project
  ARG UID
  RUN chown "$UID:$UID" /project
  USER $UID
  COPY --chown="$UID:$UID" . /project/.
  WORKDIR /project
  COPY --from=source /project /project-copy
  RUN cp -r /project-copy/. /project
  ARG BUILD_COMMANDS
  ARG SHELL_XTRACE
  RUN sh -ec $SHELL_XTRACE "$BUILD_COMMANDS" \
    || true > "$MODULE_PATH/failed"
  ARG IMAGE_NAME
  LABEL build-of=$IMAGE_NAME
  RUN ! test -f "$MODULE_PATH/failed"

FROM "$SOURCE_IMAGE_NAME" as package
  ARG UID
  USER $UID
  WORKDIR /project
